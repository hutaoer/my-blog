# 前端聚合发布流程.md

简介
因前端容器占用资源少，申请资源过多，造成资源浪费，因此公司不再通过新容器的申请。目前将前端各项目通过一套聚合流程统一打包发布到一个容器中，并进行相关的测试上线等工作。



名词
前端容器：mbweb-lgt-frontend-main-container

构建工程 pipeline ：http://pack.cloud.myhexin.com/lgt/frontend-product （内网）

构建工程：http://gitlab.myhexin.com/lgt/frontend-product.git （内网）



接入流程
新建项目仓库（内网中台 git ：http://gitlab.myhexin.com）
初始化仓库，需要有构建产物打包命令，新建分支 testing, preview, master
Pack 平台添加项目（除 sns 等旧项目外，新项目建议使用自己的账号，通过添加成员管理权限）
Pack 平台分支管理，手动添加 testing, preview, master 分支（避免自动同步添加冗余分支）
Pack 平台设置选择使用缓存，并在挂载卷列表中自行添加名称，勾选“缓存区分不同分支”
Pack 平台添加两条 pipeline
构建 pipeline 选择新增默认流程 pipeline，并添加「论股堂前端工程编译」「论股堂上传产物到构建工程」「vanish通知」三个步骤，每个步骤参数右侧均有详细说明
「论股堂前端工程编译」步骤下的cach右侧“缓存路径”中填写 step 注释中的缓存目录，即“/drone/node_modules”
sonarLint pipeline 直接添加「前端项目各平台接入」 pipeline 即可
接入完毕


发布流程
发布测试

将业务分支合并到 testing 分支
Pack 平台点击立即构建， step 参数选择「有代码变更，进行编译」和「测试」，分支选择「testing」，点击立即构建
等待 Pack 平台任务执行完后，可以在 「论股堂上传产物到构建工程」步骤的日志接近结尾的地方找到当次合并提交的 hash
切换到构建工程 pipeline ，根据合并提交 hash 找到对应的任务等待执行完毕
几分钟内，最新代码会同步到测试环境
发布完毕
发布预发布

将业务分支合并到 preview 分支
Pack 平台点击立即构建，step 参数选择「有代码变更，进行编译」和「测试」，分支选择「preview」，点击立即构建（此操作会覆盖 testing 分支在测试环境的代码，如果同一业务项目内并行开发，需要通知其他开发，避免互相覆盖或出现功能异常无法定位）
同「发布测试」3、4
在测试环境自行验证功能无误后继续，否则重新修改代码发布
Pack 平台点击立即构建，step 参数选择「无代码变更，跳过编译」和「预发布」，分支选择「preview」，点击立即构建
同「发布测试」3、4
重新发布测试，恢复被覆盖的测试分支代码
将构建工程 pipeline 中「新建发布平台发布任务」步骤日志最后一行的发布 id 提供给测试者，通知测试者发布预发布环境
发布完毕
发布正式

业务分支提mr，向 master 分支合并
Pack 平台点击立即构建，step 参数选择「有代码变更，进行编译」和「测试」，分支选择「master」，点击立即构建（此时会覆盖 testing 分支在测试环境的代码，如果同一业务项目内并行开发，需要通知其他开发，避免互相覆盖或出现功能异常无法定位）
同「发布测试」3、4
在测试环境自行验证功能无误后继续
Pack 平台点击立即构建，step 参数选择「无代码变更，跳过编译」和「预发布」，分支选择「master」，点击立即构建
同「发布测试」3、4
重新发布测试，恢复被覆盖的测试分支代码
同「发布预发布」8，可选
Pack 平台点击立即构建，step 参数选择「无代码变更，跳过编译」和「正式」，分支选择「master」，点击立即构建
同「发布测试」3、4
将构建工程 pipeline 中「新建发布平台发布任务」步骤日志最后一行的发布 id 提供给测试者，通知测试者发布正式环境
线上验证
发布完毕


其他
容器内静态资源地址（js, css, 图片等均打包到构建产物中，不需要 base64 自行修改 webpack 配置）：'//s.thsi.cn/cb?cd/mbweb-lgt-frontend-main-container/${项目仓库名称}/'，测试环境和正式环境相同
构建工程 pipeline 中的任务是自动执行的，不需要手动点
发布预发布和正式，也需要从测试环境一步一步进行，是为了避免正式发布的代码和测试过的代码不一致，即正式环境代码一定上过预发布环境并验证，预发布环境代码一定上过测试环境并验证
同一个业务项目内发布不同环境会在测试环境覆盖，因此并行开发时需要做好协调，发布后及时重新发布测试，恢复被覆盖的代码（这里后面可以优化，但是短期内不紧急）
向测试分支（testing, preview）合并业务分支可能发生冲突，解决冲突时要注意不要在环境分支引入新代码，避免测试代码和业务分支内不一致，导致出现问题。同时如果同一个项目内并行开发，要核对是否是和其他人的开发中代码发生冲突，沟通决定如何处理冲突。禁止直接覆盖他人代码（被覆盖代码版本过低，无法重新提交）
向正式分支（master）合并业务分支可能发生冲突，需要将最新的 master 分支合并到业务分支解决冲突，然后再提交向 master 合并的 mr
发布正式环境时可以去测试那边帮看一下，只有发布任务中带有 master 分支名的任务才可以发布到正式环境
发布正式环境之后开发也需要线上回归，部分情况下需要保留至少一台未访问过测试环境资源且未清除过缓存的手机（有上一个版本的正式资源缓存）查看是否正常，这是为了避免后端接口发生变化时前端还在缓存的用户无法正常使用功能