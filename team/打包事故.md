# 打包事故.md

镜像构建缓存了 html，缓存原因是因为 Dockerfile 中的 RUN 命令动态生成的内容也会被缓存，缓存后即便 RUN 命令生成的内容有更新也会使用缓存（docker build --no-cache ... 可阻止使用缓存）
最后一次构建发布，成功上传了最新的静态资源，但镜像构建使用了缓存的 html，而旧的 html 和最新的静态资源不匹配，导致开天窗（静态资源文件名后面带 md5 的 hash 值用于开启静态资源强缓存，代码有更新会产生不同的 hash 值）


针对今日资讯公告底层页空白的复盘如下
事故名称：资讯公告底层页空白（影响时间17:19 - 17:29）
页面空白的原因：前端资源404；17:12分发布公告底层页功能导致
异常发布过程描述：
 发布新需求，前端发布构建了3次
 16:45 第一次发布开发没权限（业务树开发不对应），更换有权限发布；
 16:49 第二次发布ci构建耗时17min，一直卡住没有构建完，进行取消一次（但是流程还是触发了一部分）
 17:12 第三次发布后测试验收线上页面空白


原因分析：
前端的构建产物分两部分，静态资源以及作为页面入口的 html 文件
这两部分产物发布是分离的，静态资源会上传到资源服务器，html 会通过容器发布上线
这次发布的过程中，在 CI 阶段有过多次构建，其中一次因为超长时间构建（16分钟，具体原因待运维排查）被主动取消，但镜像构建缓存了 html，缓存原因是因为 Dockerfile 中的 RUN 命令动态生成的内容也会被缓存，缓存后即便 RUN 命令生成的内容有更新也会使用缓存（docker build --no-cache ... 可阻止使用缓存）
最后一次构建发布，成功上传了最新的静态资源，但镜像构建使用了缓存的 html，而旧的 html 和最新的静态资源不匹配，导致开天窗（静态资源文件名后面带 md5 的 hash 值用于开启静态资源强缓存，代码有更新会产生不同的 hash 值）


 构建流程描述：
CI构建流程	前端打包	svn文件同步	获取html	静态资源上传发布平台	新建发布任务
第一次构建	正常	正常	正常	正常	失败（没权限）
第二次构建	正常	正常	正常	（未上传）取消	取消
第三次构建	实际未执行（docker cache）	实际未执行(docker cache)	实际未执行(docker cache)	正常	正常
 回滚处理流程：
回退项目website-news-app
回退过程：
1、17:12发布新需求后，17:18进行线上验收发现页面空白，静态资源404
2、17:19进行回退，发布平台上一版本任务关闭导致无法操作
3、17:20联系运维钟小强进行回退
4、17:24运维回复已回退
5、17:25联系运维清除代理机proxy cache
6、17:29线上验收页面正常
​
问题：
发布平台任务已关闭不能操作回退，需联系运维，增加发布回退成本
出事故和回滚过程中的10分钟内被前端机缓存的页面，需要清理缓存才能恢复，5min才清理完成
问题：
发布机制与行业标准不对齐，发布的版本和测试的版本不对齐，发布过程中产生发布内容变动，并不是整体测试过的镜像交付
没有统一的前端项目发布规范，各个业务线虽然都使用现在的 CI/CD，但看手炒和资讯的前端发布文档会觉得是两套完全不同的发布流程，相关的 Dockerfile 、Step 配置也五花八门，容易引入问题
缺少快速回滚、以及灰度发布的能力

临时解决计划：
CI中pipline添加一个取消cache的选项  @周辉
容器业务发布增加蓝绿发布模式（手动），线上新建一个部署，只对公司内部加代理访问；发布线上部署之前先发布到灰度部署验证  @杨征 3月之前前端应用全量部署
梳理目前各业务线前端的发布流程、各个业务线的前端项目发布配置（Dockerfile、Pipeline 等配置），出系统平台之前，先出一版前端发布规范，目标是将前端发布统一化规范化 @郑超 @林挺
整体规划方案：
公司统一的前端发布系统，一套标准的前端 CI/CD 发布部署，前端新人无技术成本接入 @郑超 @陆诗易
标准的灰度发布方案，保证整体系统稳定性，在初始灰度的时候就可以发现、调整问题，影响范围可控 @王海波
快速一键回滚功能，标记上一个稳定的发布版本，运维在部署平台可以一键回滚 @林挺
资讯前端页面cache一键清理机制，一键清理目前前端集群的proxy-cache，fastcgi-cache；及公司cache（平台的清理接口）