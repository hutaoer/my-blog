# 流量分配插件.md

流程互斥机制
1、互斥的理解
互斥
互斥.png
如何理解互斥？

例如我们有100个兵乓球，每25个为一组，分别染成蓝、白、橘、绿。若X实验拿的是蓝色、白色则Y实验只能拿橘色和绿色。我们说X实验的和Y实验是互斥的。

互斥实验：实验在同一层拆分流量，且不论如何拆分，不同组的流量是不重叠的。



2、我们如何保证互斥策略
实验服务请求参数支持lab_version(保留字段)，取值0~99，所有需要逻辑划分小流量实验的模块都需要支持这个参数，lab_version为实验的版本号，同一个服务最多允许100个版本实验。

基线版本的版本号为0。

当线上只有一个版本时，lab_version=0，可缺损，在调用这个服务时若不传这个参数，则默认值为0。

当只有一个版本时也可以做实验。

每个lab_version分配的流量是互斥的，所有lab_version流量之和是流量全集。



用户id随机分桶



将用户id hash到100个桶中，桶的编号从0~99，每一个桶中有1%的流量，可以得出结论：用户落入哪个桶是客观的，不会随不同实验而漂移；

按上面的分桶方法，流量最小粒度是1%；

流量分配原则：按桶编号从小到大，版本从小到大排序，从左到右取对应分量，例如：



lab_version = 0 分配80%流量；

lab_version = 1 分配15%流量；

lab_version = 2 分配 5%流量；



流量正交机制
1、正交的理解
正交
正交.png

如何理解正交?

例如我们有100个兵乓球，随机拿出来50个染成蓝色，50个染成白色，则我们有蓝色、白色兵乓球各50个，现在我们把这100个兵乓球重新放在袋子中摇匀，随机拿出50个兵乓球，那么这50个兵乓球颜色蓝色和白色各25。

当然举这个例子并不是非常的恰当，因为样本太少了，此处举例只为说明正交的意义。

正交实验：每个独立实验为一层，层与层之间流量是正交的，一份流量穿越每层实验时，都会再次随机打散，且随机效果离散。

2、我们如何保证正交策略
目前我们小流量场景只会用到组件一层，但是会存在不同的组件同时小流量实验，所以存在正交问题（不同层用相同的流量）就是不同的小流量组件都使相同的流量。

参考资料：https://coffee.pmcaff.com/article/1350873457007744/pmcaff?utm_source=forum