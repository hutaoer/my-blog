# 二期任务.md

一、一期遗留问题汇总
 缺少对接入项目所有路由的检测，人为测试验证， 容易出现遗漏location 未检测的情况 。
 个性化配置在发布平台上过于臃肿，且可扩展性较差，当 项目变多以后个性化配置文件过多不好维护。
 发布小流量项目需要连同整个项目一起发布，无法向测试保证功能没有修改。
 页面缺少一个信号，来告诉当前业务的页面当前是什么哈希版本。
 在流量开放100%的情况下，未登录用户被当成null这个特殊的userid来处理，不合理。 
 需要存在黑名单，部分小流量的功能 不应该对这部分黑名单用户开放。


二、二期解决方案 & 开发内容
 新建一个容器， 专门处理 小流量分配逻辑、路由兜底等业务逻辑。 原本的 iwc-web-result-red-rabbit 作为前端文件汇总的容器只做一件事---分配到对应的哈希html文件夹内。----- 申慧栋
 运营平台新建 赤兔路由配置、前端项目版本配置 两项。  赤兔路由配置： 新增 & 存放接入赤兔的项目，需要选择该项目的主板本哈希值、路由location信息、项目描述。
前端项目版本配置： 每一个项目对应的哈希值（hash），当前 隶属的项目（接入赤兔的），是否被作为主版本（true、false），所属的个性化配置文件（js， 存mongodb）。 运营平台前端页面——郑韬    数据库存储，赤兔读取——申慧栋
自动为所有项目在html文件中插入js 反扒js，每15分钟更新一次js  http://s.thsi.cn/js/chameleon/chameleon.min.1623216.js 其中 min.xxxxxx.js  这一部分可以用时间戳来更新。（参考nginx插入一段文件的实现方式）——申慧栋
CI CD 流程 step优化，业务方代码自动上传至赤兔   ——郑韬
当 哈希项目内的目录和html 无内容（哈希文件夹下不存在对应文件的情况），应该被重定向至（二次加载） 该项目的主板本目录下的index.html。访问路径对应的资源路径存在的话直接返回资源文件对应的内容（例： 路由配置为 /unifiedwap/  映射到 3d2xff 这个版本的代码 。那么用户访问 https://www.iwencai.com/unifiedwap/wencaiPro.html 应该返回 3d2xff/wencaiPro.html文件的内容， 如果 3d2xff/wencaiPro.html文件不存在，则返回 3d2xff/index.html的内容，如果还不存在返回404。再一个例子 请求 https://www.iwencai.com/unifiedwap/home/index  会返回d2xff/index.html的内容。特别注意只处理 /*/  、  /*/* 和 *.html 文件的二次加载，其他后缀的资源不存在直接返回404 不做二次加载处理）。
所有试验配置支持白名单——陈学志。
三、二期流程图
