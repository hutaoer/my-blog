# miaokaiyiqifupan.md

同花顺资讯页面存在网页打开过慢的情况，经统计，ios端的打开平均80分位时间达到2000ms左右，而对比同类型的应用，80分位打开时间均在1000ms以下，今日头条甚至在300ms以下，为了更好的用户体验，同花顺app资讯页优化势在必行。

此次优化的终极目的是同花顺app资讯页打开80分位的时间在300ms左右，达到资讯页秒开的目的。资讯页存在三种不同的模板，oldnews，ths-new-app和sns。计划先优化oldnews（形如news.10jqka.com.cn/m{id}的页面），然后将oldnews的优化方法同步到其他项目。对此，我们指定了三期目标，每期都有阶段性的优化目标。

一期的主要做法是从全局出发，结合lighthouse优化建议对项目整体进行优化，预期效果是20%。主要措施有以下几点。


    1.缓存规则优化。对资源就行持久化的强缓存，可利用//s.thsi.cn/cb?对资源进行10年的缓存。
    2.代码压缩。js代码和css代码进行压缩，优化资源提议，减少网络下载时间。
    3.域名预解析。提前进行dns解析和网络连接。
    4.图片懒加载。文章中的图片只有在进入可视区内才开始渲染。
    5.关键路径渲染优化。与主体文章渲染无关的脚本异步加载。


但是经过分析，其中1-4点均已实现，一期的优化点只有第5条，关键路径渲染，具体做法是将与渲染无关的js放在文章渲染之后才加载。

经统计，在渲染开始之前有20条js资源被加载，这些js的加载和执行也就直接导致了网页开始一段时间内白屏的原因。经过多次测试，将与首次渲染相关的js和首次渲染无关的js然后重新通过//s.thsi.cn/cb?规则重新组合，在渲染完成之前引入必须加载的js，在渲染之后异步加载首次渲染非必需的js。本地测试性能提升20%左右，达到预期效果。

这里引入另外一个问题，就是如何衡量网页的性能呢，如何科学的建立指标反映用户打开网页最真实的感受呢。实际上最好的指标就是LCP（最大内容渲染即首屏完成渲染时的时间），但在手机端统计LCP存在兼容问题，目前还无法使用LCP来统计。退而求其次，我们使用了 domReady这个指标，具体计算方法是DOMContentLoaded的时间戳和请求网页开始的时间戳的差值，然后通过客户端将这个时间上传到ELK中。经过ELK分析，在本次优化之前domReady的80分位的值为1400ms左右，本次优化于4月23日正式上线，在优化上线后的一段时间内指标数据基本无变化，甚至还有上升的趋势，经过分析是由于js资讯通过cb规则重新组合后导致以前的资源缓存失效，在持续观察几天后，数据略有下降，从4月28日开始，数据基本稳定在1240ms左右。上线后的实际优化提升是12%左右。

针对一期优化效果未达预期总结有如下几个原因：

    1.上线后发现带有网页上的视频无法正常播放，经分析是由于视频依赖video.js而这个js被优化到异步加载中，在有视频的网页中，此资源应该是与首次渲染直接相关的资源，为避免影响到线上，将此资源放在渲染之前加载。而在之前的测试中发现，此资源在本地环境中平均加载时间为80ms左右，如果将此资源也异步加载，20%的优化目标应该可以达到。正确的做法是判断网页中是否包含视频然后有选择的加载video.js。此优化放在二期中。
    2.一期的主要措施实际在此项目中本身都已实现，导致一期的优化措施不多。另外，一期的计划上线时间与实际上线时间差了半个多月，主要原因是负责的业务突然增加，不得不先做紧急的业务需求，还有就是一次发布经过的流程繁琐，需求找多个相关的人，而其中等待的时间就比较长。

这次的网页优化实践，加深了对网页优化的认识，也对网页优化有一个整体的思路。先从整体结构优化，然后到详细的业务代码，最后借助客户端或者其他的能力对网页进行优化。任何一个小的改动对于软件而言可能都是致命的，即使当时看着没问题，指不定将来在什么样的场景下出现问题，所以改完后一定要有经验丰富的人去审核代码。另外，应用的设计架构决定了软件的可维护性，对于oldnews这个项目而言，其设计架构比较老旧并且存在不合理的地方。结构老旧是这个项目是基于php后端生成的页面，不合理的地方在于后端其实已经生成对应的结构，但是通过vue组件的方式重新渲染了一遍，这种设计在当时可能是好的，也可能是最佳方式，但就现在流行的前后端分离架构而言，这种设计已经越来越难以维护起来。二期的优化和三期的基于客户端的优化在一定程度上都需要进行前后端分离。所以在一个项目开始的时候，一个好的设计就显得尤为重要。

经过一期的优化实践，虽然效果没有达到理想的目标，但我们整体的思路是对的。之后的优化思路还是和计划的一样，按部就班的来。并且我们需要提升沟通效率，尽可能减少等待时间，另外开发时间进行合理排期，减少碎片化的间，提升开发效率。在一期出现的问题，也需要从中总结并且有效的解决。一是建立合理的性能指标，目前的指标domready无法反映用户最真实的情况，必须要建立更加合适的指标，二是前后端分离必须要提上日程，不然后续的优化也无法展开。还有一些是我们必须要停止做的事，切不能随心所欲的修改后直接发布上线，一定要有经验丰富的人审核代码，分析影响面，规避可能存在的风险。